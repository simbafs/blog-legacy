<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Homemade CI/CD Workflow å…ˆèªªç‚ºä»€éº¼è¦è‡ªå¹¹ï¼Œæˆ‘çˆ½ï¼Œå› ç‚ºå…¶ä»–çš„éƒ½å¤ªè¤‡é›œï¼Œæˆ‘æƒ³è¦ä¹¾æ·¨æ¸…çˆ½ &amp;lt;&amp;ndash; å®˜è…”èªªæ³•
è‡ªå¹¹ CI/CD æœ‰å¹¾å€‹æ­¥é©Ÿè¦å…‹æœ
build image é€šçŸ¥ä¼ºæœå™¨ image æœ‰æ›´æ–° é‡é–‹ä¼ºæœå™¨ ç¬¬ä¸€é»ä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæ—¢ç„¶éƒ½åœ¨ GitHub ä¸Šä»£ç®¡åŸå§‹ç¢¼äº†ï¼Œç•¶ç„¶å…ˆé¸ GitHub Action å›‰ï¼Œç¬¬äºŒé»æœ‰å…©å€‹é¸æ“‡ä¸€å€‹æ˜¯ç”±ä¼ºæœå™¨æ¯éš”ä¸€æ®µæ™‚é–“å»æª¢æŸ¥ image æœ‰æ²’æœ‰æ›´æ–°ï¼Œå¯ä»¥ç”¨ é€™å€‹å¥—ä»¶ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªå–œæ­¡é€™æ¨£ï¼Œå› ç‚ºæˆ‘è¦ºå¾—ä»–æ²’æœ‰ã€ŒæŒçºŒäº¤ä»˜ã€çš„æ„Ÿè¦ºã€‚æˆ‘æƒ³åˆ°äº† webhookï¼Œæ‰€ä»¥æˆ‘è¦æ‰¾ä¸€å€‹å¯ä»¥é–‹ webhook ä¼ºæœå™¨çš„ docker imageã€‚ æŠ€è¡“éƒ½é¸å¥½äº†ï¼Œå°±ä¾†æ…¢æ…¢å¡«å‘å®Œæˆå›‰ï¼ "><title>Homemade CI/CD Workflow</title><link rel=canonical href=https://blog.simbafs.cc/p/devops/homemade-cicd-workflow/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Homemade CI/CD Workflow"><meta property="og:description" content="Homemade CI/CD Workflow å…ˆèªªç‚ºä»€éº¼è¦è‡ªå¹¹ï¼Œæˆ‘çˆ½ï¼Œå› ç‚ºå…¶ä»–çš„éƒ½å¤ªè¤‡é›œï¼Œæˆ‘æƒ³è¦ä¹¾æ·¨æ¸…çˆ½ &amp;lt;&amp;ndash; å®˜è…”èªªæ³•
è‡ªå¹¹ CI/CD æœ‰å¹¾å€‹æ­¥é©Ÿè¦å…‹æœ
build image é€šçŸ¥ä¼ºæœå™¨ image æœ‰æ›´æ–° é‡é–‹ä¼ºæœå™¨ ç¬¬ä¸€é»ä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæ—¢ç„¶éƒ½åœ¨ GitHub ä¸Šä»£ç®¡åŸå§‹ç¢¼äº†ï¼Œç•¶ç„¶å…ˆé¸ GitHub Action å›‰ï¼Œç¬¬äºŒé»æœ‰å…©å€‹é¸æ“‡ä¸€å€‹æ˜¯ç”±ä¼ºæœå™¨æ¯éš”ä¸€æ®µæ™‚é–“å»æª¢æŸ¥ image æœ‰æ²’æœ‰æ›´æ–°ï¼Œå¯ä»¥ç”¨ é€™å€‹å¥—ä»¶ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªå–œæ­¡é€™æ¨£ï¼Œå› ç‚ºæˆ‘è¦ºå¾—ä»–æ²’æœ‰ã€ŒæŒçºŒäº¤ä»˜ã€çš„æ„Ÿè¦ºã€‚æˆ‘æƒ³åˆ°äº† webhookï¼Œæ‰€ä»¥æˆ‘è¦æ‰¾ä¸€å€‹å¯ä»¥é–‹ webhook ä¼ºæœå™¨çš„ docker imageã€‚ æŠ€è¡“éƒ½é¸å¥½äº†ï¼Œå°±ä¾†æ…¢æ…¢å¡«å‘å®Œæˆå›‰ï¼ "><meta property="og:url" content="https://blog.simbafs.cc/p/devops/homemade-cicd-workflow/"><meta property="og:site_name" content="Simba çš„å–µçª©"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="CICD"><meta property="article:tag" content="devops"><meta property="article:tag" content="docker"><meta property="article:tag" content="webhook"><meta property="article:published_time" content="2023-08-07T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-07T00:00:00+00:00"><meta property="og:image" content="https://blog.simbafs.cc/og/devops/homemade-CICD-workflow.png"><meta name=twitter:site content="@simbafs"><meta name=twitter:creator content="@simbafs"><meta name=twitter:title content="Homemade CI/CD Workflow"><meta name=twitter:description content="Homemade CI/CD Workflow å…ˆèªªç‚ºä»€éº¼è¦è‡ªå¹¹ï¼Œæˆ‘çˆ½ï¼Œå› ç‚ºå…¶ä»–çš„éƒ½å¤ªè¤‡é›œï¼Œæˆ‘æƒ³è¦ä¹¾æ·¨æ¸…çˆ½ &amp;lt;&amp;ndash; å®˜è…”èªªæ³•
è‡ªå¹¹ CI/CD æœ‰å¹¾å€‹æ­¥é©Ÿè¦å…‹æœ
build image é€šçŸ¥ä¼ºæœå™¨ image æœ‰æ›´æ–° é‡é–‹ä¼ºæœå™¨ ç¬¬ä¸€é»ä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæ—¢ç„¶éƒ½åœ¨ GitHub ä¸Šä»£ç®¡åŸå§‹ç¢¼äº†ï¼Œç•¶ç„¶å…ˆé¸ GitHub Action å›‰ï¼Œç¬¬äºŒé»æœ‰å…©å€‹é¸æ“‡ä¸€å€‹æ˜¯ç”±ä¼ºæœå™¨æ¯éš”ä¸€æ®µæ™‚é–“å»æª¢æŸ¥ image æœ‰æ²’æœ‰æ›´æ–°ï¼Œå¯ä»¥ç”¨ é€™å€‹å¥—ä»¶ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªå–œæ­¡é€™æ¨£ï¼Œå› ç‚ºæˆ‘è¦ºå¾—ä»–æ²’æœ‰ã€ŒæŒçºŒäº¤ä»˜ã€çš„æ„Ÿè¦ºã€‚æˆ‘æƒ³åˆ°äº† webhookï¼Œæ‰€ä»¥æˆ‘è¦æ‰¾ä¸€å€‹å¯ä»¥é–‹ webhook ä¼ºæœå™¨çš„ docker imageã€‚ æŠ€è¡“éƒ½é¸å¥½äº†ï¼Œå°±ä¾†æ…¢æ…¢å¡«å‘å®Œæˆå›‰ï¼ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.simbafs.cc/og/devops/homemade-CICD-workflow.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-DTMEFY7DTF"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DTMEFY7DTF")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hua1d55c26052b345e2b49223d0087ef3a_89734_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ’¤</span></figure><div class=site-meta><h1 class=site-name><a href=/>Simba çš„å–µçª©</a></h1><h2 class=site-description>æˆå¤§ç‰©ç†ç³»å¤§ä¸‰</h2></div></header><ol class=social-menu><li><a href=https://github.com/simbafs target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://twitter.com/simbafs target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/index/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>å¤œæ™šæ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#build-image>Build Image</a><ol><li><a href=#æ”¯ç·šä»»å‹™æ‰¾å‡º-tag>æ”¯ç·šä»»å‹™ï¼šã€Œæ‰¾å‡º tagã€</a></li></ol></li><li><a href=#push-image>Push Image</a><ol><li><a href=#ç™»å…¥-ghcr>ç™»å…¥ GHCR</a></li><li><a href=#push-image-1>Push Image</a></li></ol></li><li><a href=#webhook>Webhook</a><ol><li><a href=#docker-composeyml>docker-compose.yml</a></li><li><a href=#hooksjson>hooks.json</a></li><li><a href=#updatesh>update.sh</a></li></ol></li><li><a href=#github-action-è§¸ç™¼-webhook>GitHub Action è§¸ç™¼ webhook</a></li><li><a href=#å®Œæ•´-github-action>å®Œæ•´ GitHub Action</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/devops/homemade-cicd-workflow/><img src=/og/devops/homemade-CICD-workflow.png loading=lazy alt="Featured image of post Homemade CI/CD Workflow"></a></div><div class=article-details><header class=article-category><a href=/categories/devops/>devops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/devops/homemade-cicd-workflow/>Homemade CI/CD Workflow</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023/08/07</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é–±è®€æ™‚é–“: 4 åˆ†é˜</time></div></footer></div></header><section class=article-content><h1 id=homemade-cicd-workflow>Homemade CI/CD Workflow</h1><p>å…ˆèªªç‚ºä»€éº¼è¦è‡ªå¹¹ï¼Œ<del>æˆ‘çˆ½</del>ï¼Œå› ç‚ºå…¶ä»–çš„éƒ½å¤ªè¤‡é›œï¼Œæˆ‘æƒ³è¦ä¹¾æ·¨æ¸…çˆ½ &lt;&ndash; å®˜è…”èªªæ³•<br>è‡ªå¹¹ CI/CD æœ‰å¹¾å€‹æ­¥é©Ÿè¦å…‹æœ</p><ol><li>build image</li><li>é€šçŸ¥ä¼ºæœå™¨ image æœ‰æ›´æ–°</li><li>é‡é–‹ä¼ºæœå™¨
ç¬¬ä¸€é»ä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæ—¢ç„¶éƒ½åœ¨ GitHub ä¸Šä»£ç®¡åŸå§‹ç¢¼äº†ï¼Œç•¶ç„¶å…ˆé¸ GitHub Action å›‰ï¼Œç¬¬äºŒé»æœ‰å…©å€‹é¸æ“‡ä¸€å€‹æ˜¯ç”±ä¼ºæœå™¨æ¯éš”ä¸€æ®µæ™‚é–“å»æª¢æŸ¥ image æœ‰æ²’æœ‰æ›´æ–°ï¼Œå¯ä»¥ç”¨ <a class=link href=https://github.com/containrrr/watchtower target=_blank rel=noopener>é€™å€‹å¥—ä»¶</a>ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªå–œæ­¡é€™æ¨£ï¼Œå› ç‚ºæˆ‘è¦ºå¾—ä»–æ²’æœ‰ã€ŒæŒçºŒäº¤ä»˜ã€çš„æ„Ÿè¦ºã€‚æˆ‘æƒ³åˆ°äº† webhookï¼Œæ‰€ä»¥æˆ‘è¦æ‰¾ä¸€å€‹å¯ä»¥é–‹ webhook ä¼ºæœå™¨çš„ docker imageã€‚
æŠ€è¡“éƒ½é¸å¥½äº†ï¼Œå°±ä¾†æ…¢æ…¢<del>å¡«å‘</del>å®Œæˆå›‰ï¼</li></ol><h2 id=build-image>Build Image</h2><p>å…ˆå‡è¨­æˆ‘å€‘çš„ Dockerfile å·²ç¶“å¯«å¥½äº†ï¼Œå¯ä»¥åƒè€ƒ <a class=link href=/p/linux/docker/dockerfile-collection/#nextjs-with-pnpm>é€™è£¡</a>ï¼Œé‚£éº¼ build é€™å€‹å‹•ä½œå°±æ˜¯é€™æ¨£å®šç¾©ï¼Œå¦å¤–æ—¢ç„¶éƒ½åœ¨ GitHub ä¸Š build image äº†ï¼Œå°±é †ä¾¿ç”¨ <a class=link href=https://ghcr.io target=_blank rel=noopener>ghcr</a> å§ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>build image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      docker build . -t ghcr.io/simbafs/coscup-attendance:latest -t ghcr.io/simbafs/coscup-attendance:${{ steps.vars.outputs.tag }}</span><span class=w>      
</span></span></span></code></pre></td></tr></table></div></div><p>è£¡é¢æœ‰å€‹å¥‡æ€ªçš„æ±è¥¿ <code>${{ steps.vars.outputs.tag }}</code>ï¼Œé€™æ˜¯ä»£è¡¨ GitHub Action æŸå€‹æ­¥é©Ÿçš„ç”¢å‡ºè®Šæ•¸ <code>tag</code>ï¼Œé€™æ˜¯ç‚ºäº†å¹« build å‡ºä¾†çš„ image åŠ ä¸Š tagï¼Œæ‰€ä»¥é–‹æ”¯ç·šä»»å‹™:ã€Œæ‰¾å‡º tagã€</p><h3 id=æ”¯ç·šä»»å‹™æ‰¾å‡º-tag>æ”¯ç·šä»»å‹™ï¼šã€Œæ‰¾å‡º tagã€</h3><p>tag ä¸æœƒæ†‘ç©ºç”Ÿå‡ºä¾†ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦ä¸€å€‹ä¾†æºï¼Œæˆ‘é¸æ“‡ git tagã€‚é‚£éº¼æ ¹æ“šè°·æ­Œå¤§ç¥çš„é–‹ç¤ºï¼Œç”¨ <code>${GITHUB_REF#refs/*/}</code> å¯ä»¥æ‰¾å‡ºé€™æ¬¡è§¸ç™¼ Action çš„ tagï¼ˆæˆ–æ˜¯ referenceï¼‰ï¼Œé‚£éº¼æˆ‘å€‘å°±åœ¨ <code>build image</code> å‰é¢æ–°å¢ä¸€å€‹æ­¥é©Ÿï¼Œä¹‹å¾Œå°±éƒ½å¯ä»¥ç”¨ <code>${{ steps.vars.outputs.tag }}</code> å–å¾— tag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;tag=${GITHUB_REF#refs/*/}&#34; &gt;&gt; $GITHUB_OUTPUT</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=push-image>Push Image</h2><h3 id=ç™»å…¥-ghcr>ç™»å…¥ GHCR</h3><p>æˆ‘å€‘å·²ç¶“æ±ºå®šè¦æ¨ä¸Š GHCR äº†ï¼Œé¦–å…ˆä¸€å®šè¦å…ˆç™»å…¥æ‰èƒ½æ¨é€çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Login to GitHub Container Registry&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>docker/login-action@v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>registry</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>${{ github.actor }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.GITHUB_TOKEN }}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„é€™è£¡ <code>${{ github.actor }}</code> å’Œ <code>${{ secrets.GITHUB_TOKEN }}</code> æ˜¯ä¸éœ€è¦è¨­å®šçš„ï¼Œä»–æœƒè‡ªå·±ä»£å…¥è©²ä»£çš„å€¼ï¼Œä¸éè¦å»è¨­å®šè£¡é¢è¨­å®šèª¿æ•´ï¼Œè®“ Action å¯ä»¥å¯«å…¥ packageï¼Œä½ç½®åœ¨ <code>settings > actions > general > Workflow permissions > read and write permissions</code></p><h3 id=push-image-1>Push Image</h3><p>push å°±å¾ˆç°¡å–®ï¼Œä¸€æ¢æŒ‡ä»¤ï¼Œä¸éæˆ‘ä¸ç¢ºå®šæ€éº¼æŠŠå…©å€‹ tag éƒ½æ¨ä¸Šå»ï¼Œå°±åˆ†æˆå…©æ¢ï¼Œå¦‚æœç¬¬ä¸€æ¢ä¸å¯«åªæ¨ <code>:latest</code> çš„è©±ï¼Œæ–°çš„ iamge æ¨ä¸Šå»èˆŠçš„å°±æœƒå¤±å» tag è®Šæˆ untagged iamgeï¼Œæ¯”è¼ƒé†œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>push image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      docker push ghcr.io/simbafs/coscup-attendance:${{ steps.vars.outputs.tag }}
</span></span></span><span class=line><span class=cl><span class=sd>      docker push ghcr.io/simbafs/coscup-attendance:latest</span><span class=w>      
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>GitHub Action é‚„æ²’å®Œå–”ï¼</p></blockquote><h2 id=webhook>Webhook</h2><p>webhook èªªç©¿äº†å°±æ˜¯è¨­å®šæ”¶åˆ° http request å¾Œè¦åšä»€éº¼ï¼Œ<del>ç”¨ bash ç¡¬å¹¹ä¹Ÿä¸æ˜¯ä¸è¡Œ</del>ï¼Œæˆ‘æ‰¾äº†ä¸€å€‹ç”¨ go å¯«çš„ç¨‹å¼ <a class=link href=https://github.com/adnanh/webhook target=_blank rel=noopener>webhook</a>ï¼Œå®šç¾©ä¸€å€‹ JSON æª”ï¼Œé™¤äº†æœ€åŸºæœ¬çš„è§¸ç™¼å¤–ï¼Œé‚„å¯ä»¥ <a class=link href=https://github.com/adnanh/webhook/blob/master/docs/Hook-Rules.md target=_blank rel=noopener>è¨­å®šæ¢ä»¶</a> ï¼ŒåŸºæœ¬çš„å€¼è¦ç›¸ç¬¦ã€regexï¼Œ é‚„æœ‰ HMAC é©—è­‰ï¼Œé€²éšä¸€é»å«æœ‰ and or not ç­‰é‚è¼¯å¯ä»¥ç”¨ã€‚å®˜æ–¹æ¨è–¦äº†ä¸‰å€‹ docker imageï¼Œ<a class=link href=https://github.com/almir/docker-webhook target=_blank rel=noopener>ç¬¬ä¸€å€‹</a> æœ€å¤šäººç”¨ï¼Œä½†æ˜¯ä»–æ²’æœ‰ shell å¯ä»¥ debugï¼Œæ‰€ä»¥æˆ‘é¸æ“‡äº† <a class=link href=https://github.com/Roxedus/docker-webhook target=_blank rel=noopener>ç¬¬äºŒå€‹</a>ã€‚</p><h3 id=docker-composeyml>docker-compose.yml</h3><p>é¦–å…ˆæ˜¯ docker-compose.yml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webhook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>roxedus/webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>PUID=0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>PGID=0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>TZ=Asiz/Taipei</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>EXTRA_PARAM=-hotreload -verbose</span><span class=w> </span><span class=c>#optional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>./hooks.json:/config/hooks/hooks.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>./script/:/var/webhook/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/volume1/docker/:/var/webhook/docker/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/usr/local/bin/docker:/usr/local/bin/docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/usr/local/bin/docker-compose:/usr/local/bin/docker-compose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=m>5748</span><span class=p>:</span><span class=m>9000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é€™è£¡ volume æ›äº†ä¸€å †æ±è¥¿ï¼Œç¬¬ä¸€å€‹æ˜¯è¨­å®šæª”ï¼Œç¬¬äºŒå€‹æ˜¯æ–¹ä¾¿æ”¾ script å’Œ logï¼Œç¬¬ä¸‰å€‹æ˜¯ç‚ºäº†åˆ°è¦æ›´æ–°çš„ docker å°ˆæ¡ˆç›®éŒ„åŸ·è¡Œ <code>docker-compose</code>ï¼Œå¾Œé¢ä¸‰å€‹éƒ½æ˜¯ç‚ºäº†å¯ä»¥åŸ·è¡Œ host ä¸Šçš„ docker æŒ‡ä»¤ã€‚</p><h3 id=hooksjson>hooks.json</h3><p>æ¥è‘—æ˜¯ <code>hooks.json</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;coscup-attendance&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;execute-command&#34;</span><span class=p>:</span> <span class=s2>&#34;/var/webhook/docker/coscup/update.sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;command-working-directory&#34;</span><span class=p>:</span> <span class=s2>&#34;/var/webhook/docker/coscup/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;trigger-rule&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;random key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nt>&#34;parameter&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;payload&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;key&#34;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p><code>id</code> å°±æ˜¯ webhook è£¡çš„ id <code>https://localhost:9000/hooks/{id}</code>ï¼Œç„¶å¾Œæ˜¯è¦åŸ·è¡Œçš„å‘½ä»¤å’Œå·¥ä½œç›®éŒ„ï¼Œå‘½ä»¤å»ºè­°å¯«çµ•å°è·¯å¾‘ï¼Œä¸éè·¯å¾‘è¦æ˜¯æ›è¼‰åˆ° docker container è£¡é¢å¾Œçš„è·¯å¾‘ï¼Œä¸æ˜¯åœ¨å¤–é¢çš„è·¯å¾‘ã€‚æ¥è‘— <code>trigger-rule</code> æè¿°äº†è¦åœ¨ payloadï¼ˆå°±æ˜¯ http bodyï¼‰ä¸­ <code>key</code> æ¬„ä½è¦æ˜¯ <code>"random key</code> æ‰æœƒåŸ·è¡Œå‘½ä»¤ï¼Œè©³ç´°è¨­å®šå¯ä»¥å» <a class=link href=https://github.com/adnanh/webhook/blob/master/docs/Hook-Rules.md target=_blank rel=noopener>é€™è£¡</a> çœ‹ã€‚ä»¥é€™è£¡çš„è¨­å®šç‚ºä¾‹ï¼Œè¦æˆåŠŸåŸ·è¡Œçš„è©±å°±è¦ç”¨ä»¥ä¸‹æ–¹å¼å‘¼å«æ‰æœƒåŸ·è¡Œ <code>update.sh</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -XPOST --header <span class=s1>&#39;Content-Type: application/json&#39;</span>  -d<span class=s1>&#39;{&#34;key&#34;: &#34;random key&#34;}&#39;</span> http://localhost:9000/hooks/coscup-attendance
</span></span></code></pre></td></tr></table></div></div><h3 id=updatesh>update.sh</h3><p>æ¥è‘—å°±æ˜¯ç•¶ webhook åŸ·è¡Œæ™‚è¦åŸ·è¡Œçš„ update.shï¼Œåªæœ‰ä¸‰å€‹æ­¥é©Ÿï¼Œdownã€pullã€up</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>cd</span> /var/webhook/docker/coscup
</span></span><span class=line><span class=cl>/usr/local/bin/docker-compose down
</span></span><span class=line><span class=cl>/usr/local/bin/docker-compose pull
</span></span><span class=line><span class=cl>/usr/local/bin/docker-compose up -d
</span></span></code></pre></td></tr></table></div></div><h2 id=github-action-è§¸ç™¼-webhook>GitHub Action è§¸ç™¼ webhook</h2><p>æœ€å¾Œä¸€æ­¥ï¼Œè¨­å®šè®“ Action build å®Œ image å¾Œå°±ç™¼ request è§¸ç™¼ webhook</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trigger webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      curl -XPOST --header &#39;Content-Type: application/json&#39;  -d&#39;{&#34;key&#34;: &#34;${{ secrets.WEBHOOK_KEY }}&#34;}&#39; &#34;https://webhook.simbafs.cc/hooks/coscup-attendance&#34;</span><span class=w>      
</span></span></span></code></pre></td></tr></table></div></div><p>é€™è£¡æŠŠ <code>"random key</code> æ‹‰å‡ºä¾†æ”¾åˆ° secrets è£¡é¢æ˜¯å› ç‚ºæˆ‘ä¸å¸Œæœ›éš¨ä¾¿ä¸€å€‹äººéƒ½èƒ½é‡å•Ÿ docker containerï¼Œé›–ç„¶ä¸æœƒæ€æ¨£ä½†æ˜¯æœå‹™æœƒè¢«ä¸­æ–·ï¼Œæ‰€ä»¥æ‰è¨­è¨ˆé€™å€‹å¯†ç¢¼ï¼Œè‡³æ–¼ç‚ºä»€éº¼ä¸ç”¨ hmac é©—è­‰å‘¢ï¼Ÿå¦‚æœæ˜¯ <code>hooks.json</code> æ´©æ¼ï¼Œé‚£éº¼æœ‰æ²’æœ‰é©—è­‰éƒ½æ²’å·®äº†ï¼Œå¦‚æœæ˜¯å°åŒ…å…§å®¹è¢«æŠ“åˆ°ï¼Œä¹Ÿæ˜¯æ²’å·®äº†ï¼Œå› ç‚ºæˆ‘çš„ payload æ¯æ¬¡éƒ½ä¸€æ¨£ï¼Œå¦‚æœ <strong>webhook</strong> èƒ½é©—è­‰æ™‚é–“ä¹‹é¡çš„æ‰æœƒæœ‰ç”¨ï¼Œæ‰€ä»¥å–®ç´”é©— value å°±å¯ä»¥äº†ï¼Œè€Œä¸”æˆ‘éƒ½æ˜¯èµ° httpsï¼Œè¦æ´©æ¼ä¹Ÿæ²’é‚£éº¼å®¹æ˜“ã€‚</p><h2 id=å®Œæ•´-github-action>å®Œæ•´ GitHub Action</h2><p>èªªäº†é€™éº¼å¤š GitHub Action éƒ½é‚„æ˜¯é›¶ç¢çš„ç‰‡æ®µï¼Œä¸‹é¢å°±æ˜¯å®Œæ•´çš„è¨­å®šæª”ï¼Œæˆ‘æŠŠ build, push å’Œ webhook åˆ†æˆå…©å€‹ jobs æ˜¯å› ç‚ºæˆ‘å…‰æ˜¯æ¸¬è©¦ webhook å°±å¥½å¹¾æ¬¡ï¼Œæ¯æ¬¡é‡è·‘ build çœŸçš„å¥½ä¹…ï¼ˆæŠ¹æ±—ã€‚å¦å¤–å¸Œæœ›ä»¥å¾Œæœ‰æ©Ÿæœƒèƒ½æŠŠ <code>build-and-push</code> æ‹†åˆ†çš„æ›´ç´°ã€‚ç„¶å¾Œé–‹é ­æˆ‘æœ‰è¨­å®šåªæœ‰ç•¶ git tag ç¬¦åˆ <code>v*.*.*</code> æ‰æœƒè§¸ç™¼é€™å€‹ Actionï¼Œä¸»è¦æ˜¯å¸Œæœ› <code>${{ steps.vars.outputs.tag }}</code> æŠ“åˆ°çš„éƒ½æ˜¯å¯ä»¥ç”¨çš„ç‰ˆæœ¬é‚Šè™Ÿï¼Œä¸æœƒæ˜¯æ²’æœ‰ä¸Šæ¨™ç±¤çš„ mainï¼Œè€Œä¸”å¯ä»¥æ§åˆ¶ä»€éº¼æ™‚å€™è¦ç™¼æ–°ç‰ˆæœ¬ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy Images to GHCR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;v*.*.*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build-and-push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Checkout GitHub Action&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Login to GitHub Container Registry&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>docker/login-action@v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>registry</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>${{ github.actor }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.GITHUB_TOKEN }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>vars</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;tag=${GITHUB_REF#refs/*/}&#34; &gt;&gt; $GITHUB_OUTPUT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo ${{ steps.vars.outputs.tag }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>build image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>                  docker build . -t ghcr.io/simbafs/coscup-attendance:latest -t ghcr.io/simbafs/coscup-attendance:${{ steps.vars.outputs.tag }}</span><span class=w>                  
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>push image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>                  docker push ghcr.io/simbafs/coscup-attendance:${{ steps.vars.outputs.tag }}
</span></span></span><span class=line><span class=cl><span class=sd>                  docker push ghcr.io/simbafs/coscup-attendance:latest</span><span class=w>                  
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>needs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>build-and-push]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trigger webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>                  curl -XPOST --header &#39;Content-Type: application/json&#39;  -d&#39;{&#34;key&#34;: &#34;${{ secrets.WEBHOOK_KEY }}&#34;}&#39; &#34;https://webhook.simbafs.cc/hooks/coscup-attendance&#34;</span><span class=w>                  
</span></span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/cicd/>CICD</a>
<a href=/tags/devops/>devops</a>
<a href=/tags/docker/>docker</a>
<a href=/tags/webhook/>webhook</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script>
<script>const gitalk=new Gitalk({clientID:" eeb2b2f9e0bfe34ffde9 ",clientSecret:"2a10208c164a8fab8622b497674285bc48a203d8",repo:"blog",owner:"simbafs",admin:["simbafs"],distractionFreeMode:!1,id:md5(location.pathname)});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Simba çš„å–µçª©</section><section class=powerby>å¥½æƒ³é¤Šè²“é˜¿~~<br>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>